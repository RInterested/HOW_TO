# From
#http://stats.stackexchange.com/questions/51494/is-the-z-test-for-difference-of-proportions-valid-for-massive-samples-with-tiny

iters <- 100000

n <- 23000
p <- 0.0027

x1i <- rbinom(iters, n, p)
x2i <- rbinom(iters, n, p)

pval1 <- rep(NA, iters)
pval2 <- rep(NA, iters)

for (i in 1:iters) {
   pval1[i] <- chisq.test(matrix(c(x1i[i], n-x1i[i], x2i[i], n-x2i[i]), nrow=2, byrow=TRUE), correct=FALSE)$p.value
   pval2[i] <- chisq.test(matrix(c(x1i[i], n-x1i[i], x2i[i], n-x2i[i]), nrow=2, byrow=TRUE), correct=TRUE)$p.value
}

round(mean(pval1 <= .05), 3)
round(mean(pval2 <= .05), 3)


## For the zprop function in http://stats.stackexchange.com/a/167988/67822

set.seed(100)
iters <- 100000

n1 <- 178
n2 <- 190
p1 <- 64/n1
p2 <- 92/n2

p1
p2

p <- mean(c(p1, p2))
p

x1 <- rbinom(iters, n1, p)
x2 <- rbinom(iters, n2, p)

mean(x1)
mean(x2)
(prop1 <- mean(x1)/n1)
(prop2 <- mean(x2)/n2)
p

pval <- 0
for (i in 1:100) {
  pval[i] <- zprop(mean(x1[i]), mean(x2[i]), n1, n2)
}


mean(pval <= .05)
